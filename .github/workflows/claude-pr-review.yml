name: Claude PR Review

on:
  pull_request:
    types: [opened, reopened, synchronize]
    paths-ignore:
      - "**.md"             # ignore documentation
      - "**.MD"
      - "**.txt"
      - "**.json"           # skip metadata/config updates if you want
      - "**/docs/**"
      - "**/CHANGELOG*"
      - "**/LICENSE*"
      - "**/README*"
      - "**/test/**"        # optionally skip pure test-only changes
      - "**/tests/**"
      - "**/fixtures/**"


permissions:
  contents: read
  pull-requests: write

jobs:
  claude-review:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get diff against base
        id: get_diff
        run: |
          git fetch origin ${{ github.base_ref }} --depth=1
          git diff origin/${{ github.base_ref }}...HEAD > pr.diff

          # truncate for safety
          MAX_SIZE=100000
          if [ $(wc -c < pr.diff) -gt $MAX_SIZE ]; then
            echo "⚠️ Diff too large, truncating..."
            head -c $MAX_SIZE pr.diff > pr.truncated.diff
            mv pr.truncated.diff pr.diff
          fi

          # expose diff as output
          echo "diff<<EOF" >> $GITHUB_OUTPUT
          cat pr.diff >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Cache Claude CLI
        uses: actions/cache@v4
        with:
          path: |
            ~/.claude
            ~/.local/bin/claude
          key: ${{ runner.os }}-claude-cli-v1

      - name: Run Claude review (base action)
        id: claude
        uses: anthropics/claude-code-base-action@beta
        with:
          # this one ALWAYS runs the prompt — no trigger needed
          prompt: |
            <!-- claude-code-review -->
            You are a senior code reviewer. Review the following pull request diff.
            Review the changes in my current git diff (staged and unstaged changes) focusing on these areas:

            1. **Code Quality & Best Practices**
              - Are there any violations of common coding standards or patterns?
              - Is the code readable, maintainable, and properly organized?
              - Are variable/function names clear and descriptive?
              - Is there any duplicated code that could be refactored?

            2. **Potential Bugs or Issues**
              - Are there any logical errors or edge cases not handled?
              - Are null/undefined checks in place where needed?
              - Are there any type mismatches or incorrect assumptions?
              - Are error conditions properly handled?

            3. **Performance Considerations**
              - Are there any inefficient algorithms or data structures?
              - Are there unnecessary re-renders (for React components)?
              - Are there any memory leaks or resource management issues?
              - Could any operations be optimized or cached?

            4. **Security Concerns**
              - Is user input properly validated and sanitized?
              - Are there any exposed sensitive data or credentials?
              - Are API endpoints properly authenticated/authorized?
              - Are there any potential injection vulnerabilities?

            5. **Test Coverage**
              - Are the changes adequately tested?
              - Are edge cases covered in tests?
              - Do the tests actually verify the intended behavior?
              - Are there any untested code paths?

            Please review my git diff and provide constructive, specific feedback. For each issue found, explain why it's a problem and suggest how to fix it. Prioritize the most critical issues first.

            Give me Markdown ONLY output with:
            - Summary
            - Issues (with severity)
            - Suggestions
            - Tests to add

            --- BEGIN DIFF ---
            ${{ steps.get_diff.outputs.diff }}
            --- END DIFF ---
          # we don't need tools for simple text review
          allowed_tools: ""
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}


      - name: Read Claude output
        id: read_claude
        run: |
          FILE="/home/runner/work/_temp/claude-execution-output.json"
          OUTFILE="claude_review.md"
          DEFAULT_MSG="Claude ran but didn't return a review. Check workflow logs."

          python - << 'PY'
          import json, os, pathlib

          file_path = "/home/runner/work/_temp/claude-execution-output.json"
          out_path = "claude_review.md"

          text = ""
          if os.path.exists(file_path):
              data = json.load(open(file_path, "r", encoding="utf-8"))
              # the action writes an array of events; the one we want has type == "result"
              if isinstance(data, list):
                  for item in data:
                      if isinstance(item, dict) and item.get("type") == "result":
                          text = item.get("result", "").strip()
              elif isinstance(data, dict) and data.get("type") == "result":
                  text = data.get("result", "").strip()

          if not text:
              raw = open(file_path, "r", encoding="utf-8").read()[:200]
              text = "Claude ran but didn't return a review.\n\nRaw snippet:\n```json\n" + raw + "\n```"

          pathlib.Path(out_path).write_text(text, encoding="utf-8")
          PY

          # now safely base64 it so we can pass via outputs
          REVIEW_B64=$(base64 -w 0 claude_review.md)
          echo "review_b64=${REVIEW_B64}" >> $GITHUB_OUTPUT


      - name: Post / update Claude review comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.payload.pull_request.number;
            const marker = '<!-- claude-pr-review -->';
            const b64 = `${{ steps.read_claude.outputs.review_b64 }}`.trim();
            const review = Buffer.from(b64, 'base64').toString('utf8').trim();

            // 1- get existing comments
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });

            // 2- collapse any older Claude comments (optional)
            for (const c of comments) {
              if (c.body && c.body.includes(marker) && !c.body.startsWith('<details>')) {
                const formattedDate = new Date(c.created_at).toLocaleDateString('en-US', {
                  month: '2-digit',
                  day: '2-digit',
                  year: 'numeric'
                });
                const collapsed = `<details>\n<summary>Previous Claude review (${c.created_at})</summary>\n\n${c.body}\n</details>`;
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: c.id,
                  body: collapsed
                });
              }
            }

            // 3- see if we already have a "live" comment (after collapsing, we won't — so just create)
            const body = `${marker}\n${review || "Claude ran but didn't return a review."}`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body
            });

