name: Claude PR Review

on:
  pull_request:
    types: [opened, reopened, edited, synchronize]

permissions:
  contents: read
  pull-requests: write

jobs:
  claude-review:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get diff against base
        id: get_diff
        run: |
          git fetch origin ${{ github.base_ref }} --depth=1
          git diff origin/${{ github.base_ref }}...HEAD > pr.diff

          # truncate for safety
          MAX_SIZE=100000
          if [ $(wc -c < pr.diff) -gt $MAX_SIZE ]; then
            echo "⚠️ Diff too large, truncating..."
            head -c $MAX_SIZE pr.diff > pr.truncated.diff
            mv pr.truncated.diff pr.diff
          fi

          # expose diff as output (multi-line)
          echo "diff<<EOF" >> $GITHUB_OUTPUT
          cat pr.diff >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Generate review with Claude
        id: claude
        continue-on-error: true
        uses: anthropics/claude-code-action@beta
        env:
          MODE: agent
        with:
          mode: agent
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          trigger_phrase: ""
          label_trigger: ""
          direct_prompt: |
            You are a senior code reviewer. Review the following pull request diff.
            Focus on:
            1. Code Quality & Best Practices
            2. Potential Bugs or Issues
            3. Performance considerations
            4. Security concerns
            5. Test coverage gaps

            For each issue, explain why it's a problem and how to fix it.
            Prioritize critical issues first.
            Return Markdown.

            --- BEGIN DIFF ---
            ${{ steps.get_diff.outputs.diff }}
            --- END DIFF ---

      - name: Comment on PR with review
        uses: actions/github-script@v7
        with:
            github-token: ${{ secrets.GITHUB_TOKEN }}
            script: |
              const prNumber = context.payload.pull_request.number;
              // the anthropics action usually returns something in 'steps.claude.outputs.result'
              let body = core.getInput('body', { required: false });
              // but we'll prefer the action's output
              const claudeOutput = `${{ toJSON(steps.claude.outputs.result) }}`.trim();
              let commentBody = claudeOutput;

              if (!claudeOutput || claudeOutput === 'null' || claudeOutput === '""') {
                commentBody = "Claude ran but didn't return a review. Check workflow logs.";
              }

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: commentBody
              });
