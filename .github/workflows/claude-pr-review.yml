name: Claude PR Review

on:
  pull_request:
    types: [opened, reopened, edited, synchronize]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  claude-review:
    runs-on: ubuntu-latest
    env:
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
    
    steps:
    - name: Checkout PR code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Get diff against base
      id: diff
      run: |
        git fetch origin ${{ github.base_ref }} --depth=1
        git diff origin/${{ github.base_ref }}...HEAD > pr.diff
        echo "Diff size: $(wc -l < pr.diff) lines"
        echo "First 10 lines of diff:"
        head -10 pr.diff
        echo "diff_path=pr.diff" >> $GITHUB_OUTPUT
    
    - name: Build prompt for Claude
      id: prompt
      run: |
        cat << 'EOF' > prompt.txt
You are an AI code reviewer. Review the following PR diff and provide concise, actionable feedback.

Focus on:
1. Potential bugs, security issues, or breaking changes
2. Code quality and best practices  
3. Missing error handling or edge cases
4. Performance concerns
5. Missing tests for non-trivial logic

Please format your response in Markdown with:
- ## Summary
- ## Issues Found (if any)
- ## Suggestions (if any)
- ## Tests Needed (if any)

Here is the diff:
EOF
        cat pr.diff >> prompt.txt
        echo "Prompt size: $(wc -c < prompt.txt) characters"
        echo "prompt_path=prompt.txt" >> $GITHUB_OUTPUT
    
    - name: Call Claude
      id: claude
      run: |
        # Check if we have a diff to review
        if [ ! -s pr.diff ]; then
          echo "## No Changes Detected" > claude_review.md
          echo "This PR appears to have no file changes to review." >> claude_review.md
          exit 0
        fi
        
        # Create the JSON payload properly
        python3 << 'PYCODE'
import json

with open("prompt.txt", "r") as f:
    prompt_content = f.read()

payload = {
    "model": "claude-3-5-sonnet-latest",
    "max_tokens": 1500,
    "messages": [
        {
            "role": "user",
            "content": prompt_content
        }
    ]
}

with open("claude_payload.json", "w") as f:
    json.dump(payload, f)
PYCODE
        
        # Call Claude API
        RESPONSE=$(curl -s https://api.anthropic.com/v1/messages \
          -H "x-api-key: $ANTHROPIC_API_KEY" \
          -H "anthropic-version: 2023-06-01" \
          -H "content-type: application/json" \
          -d @claude_payload.json)
        
        # Save raw response
        echo "$RESPONSE" > claude_raw.json
        echo "API response saved, size: $(wc -c < claude_raw.json) characters"
        
        # Extract review content with error handling
        python3 << 'PYCODE'
import json
import sys

try:
    with open("claude_raw.json") as f:
        data = json.load(f)
    
    # Check for API errors first
    if "error" in data:
        error_msg = data["error"].get("message", "Unknown error")
        print(f"## âŒ Claude API Error\n\n{error_msg}")
        with open("claude_review.md", "w") as f:
            f.write(f"## âŒ Claude API Error\n\n{error_msg}")
        sys.exit(0)
    
    # Extract text content from response
    text_parts = []
    for content_item in data.get("content", []):
        if content_item.get("type") == "text":
            text_parts.append(content_item.get("text", ""))
    
    review_text = "\n".join(text_parts).strip()
    
    if not review_text:
        fallback_msg = "## âš ï¸ No Review Generated\n\nClaude API returned an empty response."
        print(fallback_msg)
        with open("claude_review.md", "w") as f:
            f.write(fallback_msg)
    else:
        print("Review extracted successfully")
        with open("claude_review.md", "w") as f:
            f.write(review_text)
        
except json.JSONDecodeError as e:
    error_msg = f"## âŒ Failed to parse API response\n\n```\n{str(e)}\n```"
    print(error_msg)
    with open("claude_review.md", "w") as f:
        f.write(error_msg)
except Exception as e:
    error_msg = f"## âŒ Unexpected error\n\n```\n{str(e)}\n```"
    print(error_msg)
    with open("claude_review.md", "w") as f:
        f.write(error_msg)
PYCODE
        
        echo "Review file size: $(wc -c < claude_review.md) characters"
        echo "First 200 characters of review:"
        head -c 200 claude_review.md
    
    - name: Comment on PR
      run: |
        PR_NUMBER=${{ github.event.pull_request.number }}
        
        # Verify we have review content
        if [ ! -f claude_review.md ]; then
          echo "âŒ Review file not found"
          exit 1
        fi
        
        if [ ! -s claude_review.md ]; then
          echo "âŒ Review file is empty"
          exit 1
        fi
        
        # Post the comment
        echo "Posting review comment to PR #$PR_NUMBER..."
        
        python3 << 'PYCODE'
import json
import subprocess
import sys
import os

# Read the review content
with open("claude_review.md", "r") as f:
    review_body = f.read().strip()

if not review_body:
    print("âŒ Review body is empty")
    sys.exit(1)

# Prepare the comment body with header
comment_body = f"## ðŸ¤– Claude AI Code Review\n\n{review_body}"

# Prepare the GitHub API payload
payload = {
    "body": comment_body
}

# Get environment variables
pr_number = os.environ.get("PR_NUMBER")
github_token = os.environ.get("GITHUB_TOKEN") 
repo = os.environ.get("GITHUB_REPOSITORY")

if not all([pr_number, github_token, repo]):
    print("âŒ Missing required environment variables")
    sys.exit(1)

# Make the API call
import urllib.request
import urllib.parse

url = f"https://api.github.com/repos/{repo}/issues/{pr_number}/comments"
data = json.dumps(payload).encode('utf-8')

req = urllib.request.Request(url, data=data)
req.add_header('Authorization', f'Bearer {github_token}')
req.add_header('Accept', 'application/vnd.github+json')
req.add_header('Content-Type', 'application/json')

try:
    with urllib.request.urlopen(req) as response:
        result = json.loads(response.read().decode('utf-8'))
        print(f"âœ… Comment posted successfully: {result.get('html_url', 'URL not available')}")
except Exception as e:
    print(f"âŒ Failed to post comment: {str(e)}")
    sys.exit(1)
PYCODE
      env:
        PR_NUMBER: ${{ github.event.pull_request.number }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITHUB_REPOSITORY: ${{ github.repository }}