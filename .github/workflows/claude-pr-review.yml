name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize]
    # Optional: Only run on specific file changes
    # paths:
    #   - "src/**/*.ts"
    #   - "src/**/*.tsx"
    #   - "src/**/*.js"
    #   - "src/**/*.jsx"

jobs:
  claude-review:
    # Optional: Filter by PR author
    # if: |
    #   github.event.pull_request.user.login == 'external-contributor' ||
    #   github.event.pull_request.user.login == 'new-developer' ||
    #   github.event.pull_request.author_association == 'FIRST_TIME_CONTRIBUTOR'

    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Collapse Previous Claude Reviews
        uses: actions/github-script@v7
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            for (const comment of comments) {
              if (comment.user.login === 'claude[bot]' && 
                  comment.body.includes('Review Summary') &&
                  !comment.body.startsWith('<details>')) {
                
                // Extract the review content
                const reviewContent = comment.body;
                
                // Create collapsed version
                const collapsedBody = `
            <details>
            <summary>Claude Review (${new Date(comment.created_at).toLocaleDateString()})</summary>

            ${reviewContent}
            </details>`;
                
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: comment.id,
                  body: collapsedBody
                });
              }
            }

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

          # Optional: Specify model (defaults to Claude Sonnet 4, uncomment for Claude Opus 4)
          # model: "claude-opus-4-20250514"

          # Direct prompt for automated review (no @claude mention needed)
          direct_prompt: |
            <!-- claude-code-review -->
            Review the changes in my current git diff (staged and unstaged changes) focusing on these areas:

            1. **Code Quality & Best Practices**
              - Are there any violations of common coding standards or patterns?
              - Is the code readable, maintainable, and properly organized?
              - Are variable/function names clear and descriptive?
              - Is there any duplicated code that could be refactored?

            2. **Potential Bugs or Issues**
              - Are there any logical errors or edge cases not handled?
              - Are null/undefined checks in place where needed?
              - Are there any type mismatches or incorrect assumptions?
              - Are error conditions properly handled?

            3. **Performance Considerations**
              - Are there any inefficient algorithms or data structures?
              - Are there unnecessary re-renders (for React components)?
              - Are there any memory leaks or resource management issues?
              - Could any operations be optimized or cached?

            4. **Security Concerns**
              - Is user input properly validated and sanitized?
              - Are there any exposed sensitive data or credentials?
              - Are API endpoints properly authenticated/authorized?
              - Are there any potential injection vulnerabilities?

            5. **Test Coverage**
              - Are the changes adequately tested?
              - Are edge cases covered in tests?
              - Do the tests actually verify the intended behavior?
              - Are there any untested code paths?

            Please review my git diff and provide constructive, specific feedback. For each issue found, explain why it's a problem and suggest how to fix it. Prioritize the most critical issues first.


          # Optional: Customize review based on file types
          # direct_prompt: |
          #   Review this PR focusing on:
          #   - For TypeScript files: Type safety and proper interface usage
          #   - For API endpoints: Security, input validation, and error handling
          #   - For React components: Performance, accessibility, and best practices
          #   - For tests: Coverage, edge cases, and test quality

          # Optional: Different prompts for different authors
          # direct_prompt: |
          #   ${{ github.event.pull_request.author_association == 'FIRST_TIME_CONTRIBUTOR' &&
          #   'Welcome! Please review this PR from a first-time contributor. Be encouraging and provide detailed explanations for any suggestions.' ||
          #   'Please provide a thorough code review focusing on our coding standards and best practices.' }}

          # Optional: Add specific tools for running tests or linting
          # allowed_tools: "Bash(npm run test),Bash(npm run lint),Bash(npm run typecheck)"

          # Optional: Skip review for certain conditions
          # if: |
          #   !contains(github.event.pull_request.title, '[skip-review]') &&
          #   !contains(github.event.pull_request.title, '[WIP]')

      - name: Collapse Previous Claude Reviews After Just in Case
        uses: actions/github-script@v7
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            for (const comment of comments) {
              if (comment.user.login === 'claude[bot]' && 
                  comment.body.includes('PR Review') &&
                  !comment.body.startsWith('<details>')) {
                
                // Extract the review content
                const reviewContent = comment.body;
                
                // Create collapsed version
                const collapsedBody = `
            <details>
            <summary>Claude Review (${new Date(comment.created_at).toLocaleDateString()})</summary>

            ${reviewContent}
            </details>`;
                
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: comment.id,
                  body: collapsedBody
                });
              }
            }