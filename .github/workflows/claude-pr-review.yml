name: Claude PR Review

on:
  pull_request:
    types: [opened, reopened, edited, synchronize]

permissions:
  contents: read
  pull-requests: write

jobs:
  claude-review:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get diff against base
        id: get_diff
        run: |
          git fetch origin ${{ github.base_ref }} --depth=1
          git diff origin/${{ github.base_ref }}...HEAD > pr.diff

          # truncate for safety
          MAX_SIZE=100000
          if [ $(wc -c < pr.diff) -gt $MAX_SIZE ]; then
            echo "⚠️ Diff too large, truncating..."
            head -c $MAX_SIZE pr.diff > pr.truncated.diff
            mv pr.truncated.diff pr.diff
          fi

          # expose diff as output
          echo "diff<<EOF" >> $GITHUB_OUTPUT
          cat pr.diff >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Run Claude review (base action)
        id: claude
        uses: anthropics/claude-code-base-action@beta
        with:
          # this one ALWAYS runs the prompt — no trigger needed
          prompt: |
            You are a senior code reviewer. Review the following pull request diff.
            Review the changes in my current git diff (staged and unstaged changes) focusing on these areas:

            1. **Code Quality & Best Practices**
              - Are there any violations of common coding standards or patterns?
              - Is the code readable, maintainable, and properly organized?
              - Are variable/function names clear and descriptive?
              - Is there any duplicated code that could be refactored?

            2. **Potential Bugs or Issues**
              - Are there any logical errors or edge cases not handled?
              - Are null/undefined checks in place where needed?
              - Are there any type mismatches or incorrect assumptions?
              - Are error conditions properly handled?

            3. **Performance Considerations**
              - Are there any inefficient algorithms or data structures?
              - Are there unnecessary re-renders (for React components)?
              - Are there any memory leaks or resource management issues?
              - Could any operations be optimized or cached?

            4. **Security Concerns**
              - Is user input properly validated and sanitized?
              - Are there any exposed sensitive data or credentials?
              - Are API endpoints properly authenticated/authorized?
              - Are there any potential injection vulnerabilities?

            5. **Test Coverage**
              - Are the changes adequately tested?
              - Are edge cases covered in tests?
              - Do the tests actually verify the intended behavior?
              - Are there any untested code paths?

            Please review my git diff and provide constructive, specific feedback. For each issue found, explain why it's a problem and suggest how to fix it. Prioritize the most critical issues first.

            Give me Markdown ONLY output with:
            - Summary
            - Issues (with severity)
            - Suggestions
            - Tests to add

            --- BEGIN DIFF ---
            ${{ steps.get_diff.outputs.diff }}
            --- END DIFF ---
          # we don't need tools for simple text review
          allowed_tools: ""
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}


      - name: Read Claude output
        id: read_claude
        run: |
          FILE="/home/runner/work/_temp/claude-execution-output.json"
          DEFAULT_MSG="Claude ran but didn't return a review. Check workflow logs."

          python - << 'PY'
          import json, os, pathlib, sys

          file_path = "/home/runner/work/_temp/claude-execution-output.json"
          out_path = "claude_review.md"

          text = ""
          if os.path.exists(file_path):
              data = json.load(open(file_path, "r", encoding="utf-8"))
              # the action writes an array of events; the one we want has type == "result"
              if isinstance(data, list):
                  for item in data:
                      if isinstance(item, dict) and item.get("type") == "result":
                          # this is the final markdown Claude wrote
                          text = item.get("result", "").strip()
              elif isinstance(data, dict) and data.get("type") == "result":
                  text = data.get("result", "").strip()

          if not text:
              text = "Claude ran but didn't return a review. Check workflow logs."

          pathlib.Path(out_path).write_text(text, encoding="utf-8")
          PY

          echo "review<<EOF" >> $GITHUB_OUTPUT
          cat claude_review.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Comment on PR with review
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.payload.pull_request.number;
            // this is now just plain markdown text
            const review = ${{ toJSON(steps.read_claude.outputs.review) }};
            const body = (!review || review === "null" || review === '""')
              ? "Claude ran but didn't return a review. Check workflow logs."
              : review;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body
            });
